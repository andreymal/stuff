# abindiff

Набор утилит для создания, накатывания и отката бинарных патчей. Сравнивает
файлы поблочно, не учитывая смещение: если был добавлен даже лишь один байт
в начале файла, считается, что изменился весь файл. Тем не менее, это очень
хорошо работает для больших бинарных файлов, содержимое которых обычно
не смещается.


## Установка

Такая же, как и у других Python-модулей, например:

    pip install --user -e .

После этого в консоли станут доступны четыре команды: `abindiff`, `adirdiff`,
`abinpatch` и `adirpatch`. (Если не станут, проверяйте настройки переменной
окружения `PATH`, чтобы там был прописан тот `bin`, в который `pip` помещает
исполняемые файлы при установке.)

Системные требования: Linux, Python 3.4+. (Теоретически может работать
на других ОС или на более старых версиях питона, но это не проверялось.)

Если вы собираетесь патчить что-то важное, желательно прогнать тесты, чтобы
убедиться, что на вашей системе всё нормально работает:

    pip install --user 'pytest>=3.3.0' 'pytest-cov>=2.5.1' 'pytest-runner>=3.0'
    py.test tests


## Использование

Создать патч из разницы между старым и новым файлами:

    abindiff -v старый_файл новый_файл патч.abindiff

Если указать патчу расширение `.gz`, то он будет сжат.

Некоторые параметры:

- `-v` / `--verbose` — печатать прогресс в консоль. Позволяет не задаваться
  вопросом — всё зависло или просто медленно работает;

- `-b число` / `--block-size число` — размер сравниваемых блоков в байтах.
  Чем меньше, тем компактнее получится патч, но тем дольше его создание.
  По умолчанию 1024, но можно указать и 1 байт;

- `-d / --skip-del` — не записывать в патч блоки, которые были удалены
  из старого файла. Полученный патч можно будет только накатить, но
  не откатить, зато размер патча будет меньше обычного примерно в два раза.

---

Применить патч к файлу, записав результат в новый файл:

    abinpatch патч.abindiff старый_файл новый_файл

Или откатить (если патч был создан без аргумента `-d` / `--skip-del`):

    abinpatch -R патч.abindiff новый_файл старый_файл

Применить/откатить патч прямо на месте, без создания нового файла (осторожно,
при сбоях файл останется повреждён):

    abinpatch -i патч.abindiff файл

---

Сравнить все файлы в указанных каталогах между собой и записать патчи в третий
каталог:

    adirdiff -vv старый_каталог новый_каталог каталог_с_патчами

Особенности такого создания патчей:

- каталог с патчами повторяет файловую структуру нового каталога;

- для файлов, которые отсутствуют в новом каталоге, патчи созданы не будут
  (то есть применение патчей не удаляет файлы и откатить удаление файла будет
  нельзя);

- симлинки просто копируются из нового каталога как есть.

Параметры примерно те же, что и у `abindiff`, но, так как указать расширение
`.gz` теперь некуда, стоит отметить ещё один параметр:

- `-z 0..9` / `--gzip 0..9` — число, задающее степень сжатия патчей. Число
  0 (значение по умолчанию) отключает сжатие, числа от 1 до 9 задают
  собственно степень сжатия gzip.

Параметр `-v` печатает в консоль обрабатываемые в данный момент файлы, а `-vv`
выводит прогресс текущего файла, как в `abindiff`.

---

Применить патчи, созданные предыдущей командой, к каталогу (или откатить
с параметром `-R`):

    adirpatch -v каталог_с_патчами старый_каталог новый_каталог

Особенности:

- симлинки копируются из каталога с патчами в новый каталог как есть
  без изменений;

- если в каталоге с патчами есть посторонние файлы (не имеющие расширение
  `.abindiff` или `.abindiff.gz`), то они будут скопированы в новый каталог
  как есть.

---

Помимо описанных здесь, команды имеют и другие параметры; подробнее о них вы
можете узнать, запустив интересующую вас команду с параметром `--help`.
